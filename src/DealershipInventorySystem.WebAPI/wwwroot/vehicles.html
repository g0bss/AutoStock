<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ve√≠culos - AutoStock</title>
    <link rel="stylesheet" href="/css/style.css?v=20250930120540">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <img src="/imagens/Logoautostock.png?v=2025092901" alt="AutoStock" class="logo-icon"> AutoStock
                </div>
                <div class="sidebar-subtitle">Gest√£o de Estoque</div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="/dashboard.html">
                    <img src="/imagens/Dashboard.png" alt="Dashboard" class="nav-icon"> Dashboard
                </a></li>
                <li><a href="/vehicles.html" class="active">
                    <img src="/imagens/Veiculos.png" alt="Ve√≠culos" class="nav-icon"> Ve√≠culos
                </a></li>
                <li><a href="/manufacturers.html">
                    <img src="/imagens/Fabricantes.png" alt="Fabricantes" class="nav-icon"> Fabricantes
                </a></li>
                <li><a href="/customers.html">
                    <img src="/imagens/Clientes.png" alt="Clientes" class="nav-icon"> Clientes
                </a></li>
                <li><a href="/movements.html">
                    <img src="/imagens/Movimentacoes.png" alt="Movimenta√ß√µes" class="nav-icon"> Movimenta√ß√µes
                </a></li>
                <li><a href="/users.html">
                    <img src="/imagens/Usuarios.png" alt="Usu√°rios" class="nav-icon"> Usu√°rios
                </a></li>
                <li><a href="javascript:void(0)" onclick="api.logout(); return false;" id="logout-btn">
                    <img src="/imagens/Sair.png" alt="Sair" class="nav-icon"> Sair
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="header-title">Gerenciamento de Ve√≠culos</h1>
                <div class="user-menu">
                    <button class="btn btn-primary" onclick="openVehicleModal()">
                        <span>‚ûï</span> Novo Ve√≠culo
                    </button>
                    <span class="user-name" id="user-name"></span>
                    <div class="user-avatar" id="user-avatar">A</div>
                </div>
            </div>

            <div class="content-card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>VIN</th>
                                <th>Modelo</th>
                                <th>Ano</th>
                                <th>Cor</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Pre√ßo de Venda</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="vehicles-table">
                            <tr><td colspan="8" class="text-center">Carregando ve√≠culos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicle-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Novo Ve√≠culo</h3>
                <button class="modal-close" onclick="closeVehicleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="vehicle-form">
                    <input type="hidden" id="vehicle-id">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="vin" class="form-label">VIN</label>
                            <input type="text" id="vin" name="vin" class="form-input" required maxlength="17" placeholder="17 caracteres">
                        </div>

                        <div class="form-group">
                            <label for="manufacturer-id" class="form-label">Fabricante</label>
                            <select id="manufacturer-id" name="manufacturerId" class="form-input" required>
                                <option value="">Selecione um fabricante</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="make" class="form-label">Marca</label>
                            <input type="text" id="make" name="make" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label for="model" class="form-label">Modelo</label>
                            <input type="text" id="model" name="model" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label for="year" class="form-label">Ano</label>
                            <input type="number" id="year" name="year" class="form-input" required min="1900" max="2030">
                        </div>

                        <div class="form-group">
                            <label for="color" class="form-label">Cor</label>
                            <input type="text" id="color" name="color" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label for="type" class="form-label">Tipo</label>
                            <select id="type" name="type" class="form-input" required>
                                <option value="">Selecione o tipo</option>
                                <option value="0">Novo</option>
                                <option value="1">Semi-novo</option>
                                <option value="2">Usado</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="fuel-type" class="form-label">Combust√≠vel</label>
                            <select id="fuel-type" name="fuelType" class="form-input" required>
                                <option value="">Selecione o combust√≠vel</option>
                                <option value="0">Gasolina</option>
                                <option value="1">√Ålcool</option>
                                <option value="2">Flex</option>
                                <option value="3">Diesel</option>
                                <option value="4">GNV</option>
                                <option value="5">H√≠brido</option>
                                <option value="6">El√©trico</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="transmission-type" class="form-label">Transmiss√£o</label>
                            <select id="transmission-type" name="transmissionType" class="form-input" required>
                                <option value="">Selecione a transmiss√£o</option>
                                <option value="0">Manual</option>
                                <option value="1">Autom√°tica</option>
                                <option value="2">CVT</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="mileage" class="form-label">Quilometragem</label>
                            <input type="number" id="mileage" name="mileage" class="form-input" min="0">
                        </div>

                        <div class="form-group">
                            <label for="cost-price" class="form-label">Pre√ßo de Custo</label>
                            <input type="number" id="cost-price" name="costPrice" class="form-input" step="0.01" min="0">
                        </div>

                        <div class="form-group">
                            <label for="selling-price" class="form-label">Pre√ßo de Venda</label>
                            <input type="number" id="selling-price" name="sellingPrice" class="form-input" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label">Observa√ß√µes</label>
                        <textarea id="notes" name="notes" class="form-input" rows="3"></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeVehicleModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="save-btn">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        // === ROBUST VEHICLES PAGE IMPLEMENTATION ===
        console.log('üöó === VEHICLES PAGE LOADING ===');

        let vehicles = [];
        let manufacturers = [];
        let editingVehicleId = null;
        let pageInitialized = false;

        // IMMEDIATE AUTHENTICATION CHECK
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.log('‚ùå No auth token, redirecting to login');
                window.location.href = '/login.html';
                return false;
            }
            console.log('‚úÖ Authentication verified');
            return true;
        }

        // GLOBAL FUNCTIONS - REGISTERED IMMEDIATELY

        window.logout = function() {
            console.log('üö™ LOGOUT CLICKED');
            if (confirm('Tem certeza que deseja sair?')) {
                console.log('‚úÖ User confirmed logout');
                localStorage.clear();
                window.location.href = '/login.html';
            }
        };

        window.openVehicleModal = function(vehicle = null) {
            console.log('üöó OPEN VEHICLE MODAL CLICKED', vehicle ? 'EDIT' : 'NEW');
            try {
                editingVehicleId = vehicle?.id || null;

                const modal = document.getElementById('vehicle-modal');
                const title = document.getElementById('modal-title');

                if (!modal || !title) {
                    console.error('‚ùå Modal elements not found');
                    alert('Erro: Modal n√£o encontrado');
                    return;
                }

                title.textContent = vehicle ? 'Editar Ve√≠culo' : 'Novo Ve√≠culo';

                if (vehicle) {
                    console.log('üìù Filling form with vehicle data:', vehicle);
                    // Fill form with vehicle data
                    const fields = {
                        'vehicle-id': vehicle.id,
                        'vin': vehicle.vin || '',
                        'make': vehicle.make || '',
                        'model': vehicle.model || '',
                        'year': vehicle.year || '',
                        'color': vehicle.color || '',
                        'type': vehicle.type ?? '',
                        'fuel-type': vehicle.fuelType ?? '',
                        'transmission-type': vehicle.transmissionType ?? '',
                        'mileage': vehicle.mileage || '',
                        'manufacturer-id': vehicle.manufacturerId || '',
                        'cost-price': vehicle.costPrice || '',
                        'selling-price': vehicle.sellingPrice || '',
                        'notes': vehicle.notes || ''
                    };

                    Object.entries(fields).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = value;
                        } else {
                            console.warn(`‚ö†Ô∏è Element not found: ${id}`);
                        }
                    });
                } else {
                    console.log('üÜï Clearing form for new vehicle');
                    // Clear form
                    const form = document.getElementById('vehicle-form');
                    if (form) form.reset();
                    const hiddenId = document.getElementById('vehicle-id');
                    if (hiddenId) hiddenId.value = '';
                }

                // Show modal with all required styles
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '9999';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                document.body.style.overflow = 'hidden';

                console.log('‚úÖ Modal shown successfully');
            } catch (error) {
                console.error('‚ùå Error opening modal:', error);
                alert('Erro ao abrir modal: ' + error.message);
            }
        };

        window.closeVehicleModal = function() {
            console.log('‚ùå CLOSE VEHICLE MODAL CLICKED');
            try {
                const modal = document.getElementById('vehicle-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    console.log('‚úÖ Modal closed successfully');
                }
                editingVehicleId = null;
            } catch (error) {
                console.error('‚ùå Error closing modal:', error);
            }
        };

        window.editVehicle = function(id) {
            console.log('‚úèÔ∏è EDIT VEHICLE CLICKED:', id);
            const vehicle = vehicles.find(v => v.id === id);
            if (vehicle) {
                window.openVehicleModal(vehicle);
            } else {
                console.error('‚ùå Vehicle not found:', id);
                alert('Ve√≠culo n√£o encontrado');
            }
        };

        window.deleteVehicle = function(id) {
            console.log('üóëÔ∏è DELETE VEHICLE CLICKED:', id);
            if (confirm('Tem certeza que deseja excluir este ve√≠culo?')) {
                console.log('‚ö†Ô∏è Executing delete for vehicle:', id);
                deleteVehicleAsync(id);
            }
        };

        async function deleteVehicleAsync(id) {
            try {
                await api.deleteVehicle(id);
                vehicles = vehicles.filter(v => v.id !== id);
                displayVehicles();
                alert('Ve√≠culo exclu√≠do com sucesso!');
            } catch (error) {
                console.error('‚ùå Error deleting vehicle:', error);
                alert('Erro ao excluir ve√≠culo: ' + error.message);
            }
        }

        // USER INFO UPDATE FUNCTION
        function forceUpdateUserInfo() {
            try {
                const userNameElement = document.getElementById('user-name');
                const userAvatarElement = document.getElementById('user-avatar');

                if (!userNameElement || !userAvatarElement) {
                    console.warn('‚ö†Ô∏è User info elements not found yet');
                    return;
                }

                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                console.log('üë§ Updating user info:', currentUser);

                if (currentUser && Object.keys(currentUser).length > 0) {
                    let displayName = 'Usu√°rio';
                    let avatarLetter = 'U';

                    // Try multiple field formats
                    if (currentUser.firstName || currentUser.FirstName) {
                        const firstName = currentUser.firstName || currentUser.FirstName;
                        const lastName = currentUser.lastName || currentUser.LastName || '';
                        displayName = `${firstName} ${lastName}`.trim();
                        avatarLetter = firstName.charAt(0).toUpperCase();
                    } else if (currentUser.fullName || currentUser.FullName) {
                        displayName = currentUser.fullName || currentUser.FullName;
                        avatarLetter = displayName.charAt(0).toUpperCase();
                    } else if (currentUser.userName || currentUser.UserName) {
                        displayName = currentUser.userName || currentUser.UserName;
                        avatarLetter = displayName.charAt(0).toUpperCase();
                    } else if (currentUser.email || currentUser.Email) {
                        const email = currentUser.email || currentUser.Email;
                        displayName = email.split('@')[0];
                        avatarLetter = displayName.charAt(0).toUpperCase();
                    }

                    userNameElement.textContent = displayName;
                    userAvatarElement.textContent = avatarLetter;
                    console.log(`‚úÖ User info updated: ${displayName} (${avatarLetter})`);
                } else {
                    // Fallback
                    userNameElement.textContent = 'Administrador';
                    userAvatarElement.textContent = 'A';
                    console.log('‚ö†Ô∏è Using fallback user info');
                }
            } catch (error) {
                console.error('‚ùå Error in forceUpdateUserInfo:', error);
            }
        }

        // DATA LOADING FUNCTIONS
        async function loadData() {
            console.log('üìä === LOADING DATA ===');
            try {
                if (!window.api) {
                    console.warn('‚ö†Ô∏è API not ready, skipping data load');
                    return;
                }

                const [vehiclesData, manufacturersData] = await Promise.all([
                    api.getVehicles(),
                    api.getManufacturers()
                ]);

                vehicles = vehiclesData || [];
                manufacturers = manufacturersData || [];

                console.log(`‚úÖ Vehicles loaded: ${vehicles.length}`);
                console.log(`‚úÖ Manufacturers loaded: ${manufacturers.length}`);

                displayVehicles();
                populateManufacturerSelect();

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                const tbody = document.getElementById('vehicles-table');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">Erro ao carregar dados</td></tr>';
                }
            }
        }

        function displayVehicles() {
            const tbody = document.getElementById('vehicles-table');
            if (!tbody) {
                console.error('‚ùå Vehicles table not found');
                return;
            }

            if (vehicles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum ve√≠culo encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = vehicles.map(vehicle => {
                const statusBadge = window.utils?.getVehicleStatusBadge(vehicle.status) || { text: 'N/A', class: 'badge-secondary' };
                const typeBadge = window.utils?.getVehicleTypeBadge(vehicle.type) || { text: 'N/A', class: 'badge-secondary' };
                const priceFormatted = window.utils?.formatCurrency(vehicle.sellingPrice) || `R$ ${vehicle.sellingPrice}`;

                return `
                    <tr>
                        <td>${vehicle.vin || 'N/A'}</td>
                        <td>${vehicle.make || ''} ${vehicle.model || ''}</td>
                        <td>${vehicle.year || 'N/A'}</td>
                        <td>${vehicle.color || 'N/A'}</td>
                        <td><span class="badge ${typeBadge.class}">${typeBadge.text}</span></td>
                        <td><span class="badge ${statusBadge.class}">${statusBadge.text}</span></td>
                        <td>${priceFormatted}</td>
                        <td>
                            <div class="flex gap-2">
                                <button class="btn btn-outline" onclick="editVehicle(${vehicle.id})" style="padding: 0.375rem 0.75rem;">‚úèÔ∏è</button>
                                <button class="btn btn-danger" onclick="deleteVehicle(${vehicle.id})" style="padding: 0.375rem 0.75rem;">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log(`‚úÖ Displayed ${vehicles.length} vehicles`);
        }

        function populateManufacturerSelect() {
            const select = document.getElementById('manufacturer-id');
            if (!select) {
                console.warn('‚ö†Ô∏è Manufacturer select not found');
                return;
            }

            select.innerHTML = '<option value="">Selecione um fabricante</option>' +
                manufacturers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');

            console.log(`‚úÖ Manufacturer select populated with ${manufacturers.length} options`);
        }

        // FORM SUBMISSION HANDLER
        function setupFormHandler() {
            const form = document.getElementById('vehicle-form');
            if (!form) {
                console.warn('‚ö†Ô∏è Form not found yet');
                return;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('üíæ FORM SUBMITTED');

                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvando...';

                try {
                    const formData = {
                        vin: document.getElementById('vin').value,
                        make: document.getElementById('make').value,
                        model: document.getElementById('model').value,
                        year: parseInt(document.getElementById('year').value),
                        color: document.getElementById('color').value,
                        type: parseInt(document.getElementById('type').value),
                        fuelType: parseInt(document.getElementById('fuel-type').value),
                        transmissionType: parseInt(document.getElementById('transmission-type').value),
                        mileage: parseInt(document.getElementById('mileage').value) || 0,
                        costPrice: parseFloat(document.getElementById('cost-price').value) || 0,
                        sellingPrice: parseFloat(document.getElementById('selling-price').value),
                        notes: document.getElementById('notes').value || null,
                        manufacturerId: parseInt(document.getElementById('manufacturer-id').value)
                    };

                    let savedVehicle;
                    if (editingVehicleId) {
                        // For update, we need to include status field
                        const currentVehicle = vehicles.find(v => v.id === editingVehicleId);
                        const updateData = {
                            ...formData,
                            status: currentVehicle?.status ?? 0 // Keep existing status or default to Available
                        };
                        savedVehicle = await api.updateVehicle(editingVehicleId, updateData);
                        const index = vehicles.findIndex(v => v.id === editingVehicleId);
                        if (index !== -1) {
                            vehicles[index] = savedVehicle;
                        }
                        alert('Ve√≠culo atualizado com sucesso!');
                    } else {
                        savedVehicle = await api.createVehicle(formData);
                        vehicles.push(savedVehicle);
                        alert('Ve√≠culo criado com sucesso!');
                    }

                    displayVehicles();
                    window.closeVehicleModal();

                } catch (error) {
                    console.error('‚ùå Error saving vehicle:', error);
                    alert('Erro ao salvar ve√≠culo: ' + error.message);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            });

            console.log('‚úÖ Form handler setup complete');
        }

        // INITIALIZATION FUNCTION
        function initializePage() {
            if (pageInitialized) {
                console.log('‚ö†Ô∏è Page already initialized');
                return;
            }

            console.log('üöÄ === INITIALIZING PAGE ===');

            // Force user info update immediately
            forceUpdateUserInfo();

            // Set up repeated updates for user info
            setInterval(forceUpdateUserInfo, 3000);

            // Set up form handler
            setupFormHandler();

            // Try to load data
            loadData();

            pageInitialized = true;
            console.log('‚úÖ Page initialization complete');
        }

        // START EXECUTION
        if (checkAuth()) {
            console.log('üìã Authentication passed, starting initialization...');

            // MULTIPLE DOM READY LISTENERS FOR MAXIMUM COMPATIBILITY
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePage);
                console.log('üìù Added DOMContentLoaded listener');
            } else {
                console.log('üìÑ DOM already ready, initializing immediately');
                initializePage();
            }

            // Backup initialization attempts
            setTimeout(() => {
                console.log('‚è∞ Backup initialization (1s)');
                initializePage();
            }, 1000);

            setTimeout(() => {
                console.log('‚è∞ Final backup initialization (3s)');
                initializePage();
            }, 3000);

            console.log('üéØ === VEHICLES PAGE SETUP COMPLETE ===');
        }
    </script>
</body>
</html>