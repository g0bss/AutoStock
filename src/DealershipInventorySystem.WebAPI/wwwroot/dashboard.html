<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AutoStock</title>
    <link rel="stylesheet" href="/css/style.css?v=20250930120540">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <img src="/imagens/Logoautostock.png?v=2025092901" alt="AutoStock" class="logo-icon"> AutoStock
                </div>
                <div class="sidebar-subtitle">Gest√£o de Estoque</div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="/dashboard.html" class="active">
                    <img src="/imagens/Dashboard.png" alt="Dashboard" class="nav-icon"> Dashboard
                </a></li>
                <li><a href="/vehicles.html">
                    <img src="/imagens/Veiculos.png" alt="Ve√≠culos" class="nav-icon"> Ve√≠culos
                </a></li>
                <li><a href="/manufacturers.html">
                    <img src="/imagens/Fabricantes.png" alt="Fabricantes" class="nav-icon"> Fabricantes
                </a></li>
                <li><a href="/customers.html">
                    <img src="/imagens/Clientes.png" alt="Clientes" class="nav-icon"> Clientes
                </a></li>
                <li><a href="/movements.html">
                    <img src="/imagens/Movimentacoes.png" alt="Movimenta√ß√µes" class="nav-icon"> Movimenta√ß√µes
                </a></li>
                <li><a href="/users.html">
                    <img src="/imagens/Usuarios.png" alt="Usu√°rios" class="nav-icon"> Usu√°rios
                </a></li>
                <li><a href="javascript:void(0)" onclick="api.logout(); return false;" id="logout-btn">
                    <img src="/imagens/Sair.png" alt="Sair" class="nav-icon"> Sair
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="header-title">Dashboard</h1>
                <div class="user-menu">
                    <span class="user-name" id="user-name"></span>
                    <div class="user-avatar" onclick="openProfileModal()" style="cursor: pointer; transition: all 0.3s ease;">A</div>
                </div>
            </div>

            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-vehicles">-</div>
                    <div class="stat-label">Total de Ve√≠culos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="available-vehicles">-</div>
                    <div class="stat-label">Ve√≠culos Dispon√≠veis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sold-vehicles">-</div>
                    <div class="stat-label">Ve√≠culos Vendidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-customers">-</div>
                    <div class="stat-label">Total de Clientes</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Atividades Recentes</h2>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Ve√≠culo</th>
                                    <th>Cliente</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activities">
                                <tr>
                                    <td colspan="5" class="text-center">Carregando atividades...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">A√ß√µes R√°pidas</h2>
                </div>
                <div class="card-content">
                    <div class="flex gap-4">
                        <a href="/vehicles.html" class="btn btn-primary">
                            <span>üöó</span> Adicionar Ve√≠culo
                        </a>
                        <a href="/customers.html" class="btn btn-secondary">
                            <span>üë•</span> Novo Cliente
                        </a>
                        <a href="/movements.html" class="btn btn-success">
                            <span>üìã</span> Registrar Movimento
                        </a>
                        <a href="/swagger" class="btn btn-outline" target="_blank">
                            <span>üìö</span> API Documentation
                        </a>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">Status do Sistema</h2>
                </div>
                <div class="card-content" id="system-status">
                    <p>Carregando status...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Editar Perfil</h3>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="profile-firstname" class="form-label">Nome *</label>
                            <input type="text" id="profile-firstname" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="profile-lastname" class="form-label">Sobrenome *</label>
                            <input type="text" id="profile-lastname" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="profile-email" class="form-label">Email *</label>
                        <input type="email" id="profile-email" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label for="profile-username" class="form-label">Nome de Usu√°rio *</label>
                        <input type="text" id="profile-username" class="form-input" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="profile-password" class="form-label">Nova Senha (deixe em branco para manter atual)</label>
                        <input type="password" id="profile-password" class="form-input" minlength="6">
                    </div>

                    <div class="form-group">
                        <label for="profile-confirm-password" class="form-label">Confirmar Nova Senha</label>
                        <input type="password" id="profile-confirm-password" class="form-input" minlength="6">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeProfileModal()">Cancelar</button>
                <button type="submit" form="profile-form" class="btn btn-primary" id="profile-save-btn">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        // Check authentication
        if (!requireAuth()) {
            return;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            initNavigation();
            initUserInfo();
            await loadDashboardData();
        });


        async function loadDashboardData() {
            try {
                console.log('Dashboard - Loading data...');

                // Load all data in parallel with individual error handling
                const vehiclesPromise = api.getVehicles().catch(err => {
                    console.error('Error loading vehicles:', err);
                    return [];
                });

                const customersPromise = api.getCustomers().catch(err => {
                    console.error('Error loading customers:', err);
                    return [];
                });

                const movementsPromise = api.getVehicleMovements().catch(err => {
                    console.error('Error loading movements:', err);
                    return [];
                });

                const healthPromise = api.getHealth().catch(err => {
                    console.error('Error loading system health:', err);
                    return null;
                });

                const [vehicles, customers, movements, systemHealth] = await Promise.all([
                    vehiclesPromise,
                    customersPromise,
                    movementsPromise,
                    healthPromise
                ]);

                console.log('Dashboard - Data loaded:');
                console.log('Vehicles:', vehicles);
                console.log('Customers:', customers);
                console.log('Movements:', movements);
                console.log('Health:', systemHealth);

                // Update statistics
                updateStatistics(vehicles, customers, movements);

                // Update recent activities
                updateRecentActivities(movements, vehicles, customers);

                // Update system status
                updateSystemStatus(systemHealth);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                utils.showError('Erro ao carregar dados do dashboard');
            }
        }

        function updateStatistics(vehicles, customers, movements) {
            // Total vehicles
            document.getElementById('total-vehicles').textContent = vehicles.length;

            // Available vehicles (status = 0)
            const availableVehicles = vehicles.filter(v => v.status === 0).length;
            document.getElementById('available-vehicles').textContent = availableVehicles;

            // Sold vehicles (status = 2)
            const soldVehicles = vehicles.filter(v => v.status === 2).length;
            document.getElementById('sold-vehicles').textContent = soldVehicles;

            // Total customers
            document.getElementById('total-customers').textContent = customers.length;
        }

        function updateRecentActivities(movements, vehicles, customers) {
            const tbody = document.getElementById('recent-activities');

            if (!movements || movements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma atividade encontrada</td></tr>';
                return;
            }

            // Sort movements by date (most recent first) and take first 5
            const recentMovements = movements
                .sort((a, b) => new Date(b.movementDate) - new Date(a.movementDate))
                .slice(0, 5);

            tbody.innerHTML = recentMovements.map(movement => {
                const vehicle = vehicles.find(v => v.id === movement.vehicleId);
                const customer = customers.find(c => c.id === movement.customerId);

                const movementTypes = {
                    0: 'Entrada',
                    1: 'Venda',
                    2: 'Reserva',
                    3: 'Test Drive',
                    4: 'Manuten√ß√£o',
                    5: 'Transfer√™ncia'
                };

                return `
                    <tr>
                        <td>${utils.formatDateOnly(movement.movementDate)}</td>
                        <td>${movementTypes[movement.movementType] || 'Desconhecido'}</td>
                        <td>${vehicle ? `${vehicle.make} ${vehicle.model} (${vehicle.year})` : 'Ve√≠culo n√£o encontrado'}</td>
                        <td>${customer ? customer.name : movement.customerId ? 'Cliente n√£o encontrado' : '-'}</td>
                        <td>
                            <span class="badge ${movement.movementType === 1 ? 'badge-success' : 'badge-secondary'}">
                                ${movementTypes[movement.movementType] || 'Desconhecido'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateSystemStatus(healthData) {
            const statusDiv = document.getElementById('system-status');

            if (!healthData) {
                statusDiv.innerHTML = '<p class="text-danger">‚ùå Erro ao conectar com o sistema</p>';
                return;
            }

            statusDiv.innerHTML = `
                <div class="flex items-center gap-4">
                    <div>
                        <strong>Status:</strong>
                        <span class="badge badge-success">‚úÖ ${healthData.status}</span>
                    </div>
                    <div>
                        <strong>Banco de Dados:</strong>
                        <span class="badge badge-success">üóÑÔ∏è ${healthData.database.status}</span>
                    </div>
                    <div>
                        <strong>√öltima Atualiza√ß√£o:</strong>
                        ${utils.formatDate(healthData.timestamp)}
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <div><strong>Fabricantes:</strong> ${healthData.database.manufacturers}</div>
                    <div><strong>Usu√°rios:</strong> ${healthData.database.users}</div>
                    <div><strong>Ve√≠culos:</strong> ${healthData.database.vehicles}</div>
                </div>
            `;
        }

        // Profile management functions
        function openProfileModal() {
            const currentUser = api.getCurrentUser();
            if (currentUser) {
                document.getElementById('profile-firstname').value = currentUser.firstName || '';
                document.getElementById('profile-lastname').value = currentUser.lastName || '';
                document.getElementById('profile-email').value = currentUser.email || '';
                document.getElementById('profile-username').value = currentUser.userName || '';
                document.getElementById('profile-password').value = '';
                document.getElementById('profile-confirm-password').value = '';
            }
            Modal.show('profile-modal');
        }

        function closeProfileModal() {
            Modal.hide('profile-modal');
        }

        // Setup profile form submission
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const password = document.getElementById('profile-password').value;
                const confirmPassword = document.getElementById('profile-confirm-password').value;

                if (password && password !== confirmPassword) {
                    utils.showError('As senhas n√£o coincidem!');
                    return;
                }

                const saveBtn = document.getElementById('profile-save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvando...';

                try {
                    const currentUser = api.getCurrentUser();
                    const formData = {
                        firstName: document.getElementById('profile-firstname').value,
                        lastName: document.getElementById('profile-lastname').value,
                        email: document.getElementById('profile-email').value,
                        userName: document.getElementById('profile-username').value
                    };

                    if (password) {
                        formData.password = password;
                    }

                    await api.updateUser(currentUser.id, formData);

                    // Update current user data
                    const updatedUser = { ...currentUser, ...formData };
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    api.currentUser = updatedUser;

                    // Update UI
                    initUserInfo();

                    utils.showSuccess('Perfil atualizado com sucesso!');
                    closeProfileModal();

                } catch (error) {
                    console.error('Error updating profile:', error);
                    utils.showError('Erro ao atualizar perfil: ' + error.message);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            });

            // Modal close on backdrop click
            document.getElementById('profile-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeProfileModal();
                }
            });

            // Password confirmation validation
            document.getElementById('profile-confirm-password').addEventListener('input', (e) => {
                const password = document.getElementById('profile-password').value;
                const confirmPassword = e.target.value;

                if (password && confirmPassword && password !== confirmPassword) {
                    e.target.setCustomValidity('As senhas n√£o coincidem');
                } else {
                    e.target.setCustomValidity('');
                }
            });
        });

        // Global functions for HTML onclick
        window.openProfileModal = openProfileModal;
        window.closeProfileModal = closeProfileModal;

        // Simple logout function
        window.logout = function() {
            console.log('Logout function called');
            if (confirm('Tem certeza que deseja sair?')) {
                // Clear storage
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                // Redirect to login
                window.location.href = '/login.html';
            }
        };
    </script>
</body>
</html>