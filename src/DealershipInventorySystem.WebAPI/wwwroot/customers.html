<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - AutoStock</title>
    <link rel="stylesheet" href="/css/style.css?v=20250930120540">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <img src="/imagens/Logoautostock.png?v=2025092901" alt="AutoStock" class="logo-icon"> AutoStock
                </div>
                <div class="sidebar-subtitle">Gest√£o de Estoque</div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="/dashboard.html">
                    <img src="/imagens/Dashboard.png" alt="Dashboard" class="nav-icon"> Dashboard
                </a></li>
                <li><a href="/vehicles.html">
                    <img src="/imagens/Veiculos.png" alt="Ve√≠culos" class="nav-icon"> Ve√≠culos
                </a></li>
                <li><a href="/manufacturers.html">
                    <img src="/imagens/Fabricantes.png" alt="Fabricantes" class="nav-icon"> Fabricantes
                </a></li>
                <li><a href="/customers.html" class="active">
                    <img src="/imagens/Clientes.png" alt="Clientes" class="nav-icon"> Clientes
                </a></li>
                <li><a href="/movements.html">
                    <img src="/imagens/Movimentacoes.png" alt="Movimenta√ß√µes" class="nav-icon"> Movimenta√ß√µes
                </a></li>
                <li><a href="/users.html">
                    <img src="/imagens/Usuarios.png" alt="Usu√°rios" class="nav-icon"> Usu√°rios
                </a></li>
                <li><a href="javascript:void(0)" onclick="api.logout(); return false;" id="logout-btn">
                    <img src="/imagens/Sair.png" alt="Sair" class="nav-icon"> Sair
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="header-title">Gerenciamento de Clientes</h1>
                <div class="user-menu">
                    <button class="btn btn-primary" onclick="openCustomerModal()">
                        <span>‚ûï</span> Novo Cliente
                    </button>
                    <span class="user-name" id="user-name"></span>
                    <div class="user-avatar" id="user-avatar">A</div>
                </div>
            </div>

            <!-- Customers Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Lista de Clientes</h2>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF</th>
                                    <th>Email</th>
                                    <th>Telefone</th>
                                    <th>Cidade</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table">
                                <tr>
                                    <td colspan="6" class="text-center">Carregando clientes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Customer Modal -->
    <div id="customer-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Novo Cliente</h3>
                <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <input type="hidden" id="customer-id">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="name" class="form-label">Nome Completo *</label>
                            <input type="text" id="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="cpf" class="form-label">CPF *</label>
                            <input type="text" id="cpf" class="form-input" required placeholder="000.000.000-00">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="phone" class="form-label">Telefone *</label>
                            <input type="text" id="phone" class="form-input" required placeholder="(11) 99999-9999">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="address" class="form-label">Endere√ßo *</label>
                        <input type="text" id="address" class="form-input" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="city" class="form-label">Cidade *</label>
                            <input type="text" id="city" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="state" class="form-label">Estado *</label>
                            <input type="text" id="state" class="form-input" required maxlength="2" placeholder="SP">
                        </div>
                        <div class="form-group">
                            <label for="postal-code" class="form-label">CEP *</label>
                            <input type="text" id="postal-code" class="form-input" required placeholder="00000-000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="birth-date" class="form-label">Data de Nascimento</label>
                        <input type="date" id="birth-date" class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label">Observa√ß√µes</label>
                        <textarea id="notes" class="form-input" rows="3" style="min-height: 80px; resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeCustomerModal()">Cancelar</button>
                <button type="submit" form="customer-form" class="btn btn-primary" id="save-btn">Salvar</button>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        // === ROBUST CUSTOMERS PAGE IMPLEMENTATION ===
        console.log('üë• === CUSTOMERS PAGE LOADING ===');

        let customers = [];
        let editingCustomerId = null;
        let pageInitialized = false;

        // IMMEDIATE AUTHENTICATION CHECK
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.log('‚ùå No auth token, redirecting to login');
                window.location.href = '/login.html';
                return false;
            }
            console.log('‚úÖ Authentication verified');
            return true;
        }

        // GLOBAL FUNCTIONS - REGISTERED IMMEDIATELY

        window.logout = function() {
            console.log('üö™ LOGOUT CLICKED');
            if (confirm('Tem certeza que deseja sair?')) {
                console.log('‚úÖ User confirmed logout');
                localStorage.clear();
                window.location.href = '/login.html';
            }
        };

        window.openCustomerModal = function(customer = null) {
            console.log('üë• OPEN CUSTOMER MODAL CLICKED', customer ? 'EDIT' : 'NEW');
            try {
                editingCustomerId = customer?.id || null;

                const modal = document.getElementById('customer-modal');
                const title = document.getElementById('modal-title');

                if (!modal || !title) {
                    console.error('‚ùå Modal elements not found');
                    alert('Erro: Modal n√£o encontrado');
                    return;
                }

                title.textContent = customer ? 'Editar Cliente' : 'Novo Cliente';

                if (customer) {
                    console.log('üìù Filling form with customer data:', customer);
                    document.getElementById('customer-id').value = customer.id;
                    document.getElementById('name').value = customer.name || '';
                    document.getElementById('cpf').value = customer.cpf || '';
                    document.getElementById('email').value = customer.email || '';
                    document.getElementById('phone').value = customer.phone || '';
                    document.getElementById('address').value = customer.address || '';
                    document.getElementById('city').value = customer.city || '';
                    document.getElementById('state').value = customer.state || '';
                    document.getElementById('postal-code').value = customer.postalCode || '';
                    document.getElementById('birth-date').value = customer.birthDate ? customer.birthDate.split('T')[0] : '';
                    document.getElementById('notes').value = customer.notes || '';
                } else {
                    console.log('üÜï Clearing form for new customer');
                    const form = document.getElementById('customer-form');
                    if (form) form.reset();
                    const hiddenId = document.getElementById('customer-id');
                    if (hiddenId) hiddenId.value = '';
                }

                // Show modal with all required styles
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '9999';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                document.body.style.overflow = 'hidden';

                console.log('‚úÖ Modal shown successfully');
            } catch (error) {
                console.error('‚ùå Error opening modal:', error);
                alert('Erro ao abrir modal: ' + error.message);
            }
        };

        window.closeCustomerModal = function() {
            console.log('‚ùå CLOSE CUSTOMER MODAL CLICKED');
            try {
                const modal = document.getElementById('customer-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    console.log('‚úÖ Modal closed successfully');
                }
                editingCustomerId = null;
            } catch (error) {
                console.error('‚ùå Error closing modal:', error);
            }
        };

        window.editCustomer = function(id) {
            console.log('‚úèÔ∏è EDIT CUSTOMER CLICKED:', id);
            const customer = customers.find(c => c.id === id);
            if (customer) {
                window.openCustomerModal(customer);
            } else {
                console.error('‚ùå Customer not found:', id);
                alert('Cliente n√£o encontrado');
            }
        };

        window.deleteCustomer = function(id) {
            console.log('üóëÔ∏è DELETE CUSTOMER CLICKED:', id);
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                console.log('‚ö†Ô∏è Executing delete for customer:', id);
                deleteCustomerAsync(id);
            }
        };

        async function deleteCustomerAsync(id) {
            try {
                await api.deleteCustomer(id);
                customers = customers.filter(c => c.id !== id);
                displayCustomers();
                alert('Cliente exclu√≠do com sucesso!');
            } catch (error) {
                console.error('‚ùå Error deleting customer:', error);
                alert('Erro ao excluir cliente: ' + error.message);
            }
        }

        // USER INFO UPDATE FUNCTION
        function forceUpdateUserInfo() {
            try {
                const userNameElement = document.getElementById('user-name');
                const userAvatarElement = document.getElementById('user-avatar');

                if (!userNameElement || !userAvatarElement) {
                    console.warn('‚ö†Ô∏è User info elements not found yet');
                    return;
                }

                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

                if (currentUser && Object.keys(currentUser).length > 0) {
                    let displayName = 'Usu√°rio';
                    let avatarLetter = 'U';

                    if (currentUser.firstName || currentUser.FirstName) {
                        const firstName = currentUser.firstName || currentUser.FirstName;
                        const lastName = currentUser.lastName || currentUser.LastName || '';
                        displayName = `${firstName} ${lastName}`.trim();
                        avatarLetter = firstName.charAt(0).toUpperCase();
                    } else if (currentUser.fullName || currentUser.FullName) {
                        displayName = currentUser.fullName || currentUser.FullName;
                        avatarLetter = displayName.charAt(0).toUpperCase();
                    } else if (currentUser.userName || currentUser.UserName) {
                        displayName = currentUser.userName || currentUser.UserName;
                        avatarLetter = displayName.charAt(0).toUpperCase();
                    } else if (currentUser.email || currentUser.Email) {
                        const email = currentUser.email || currentUser.Email;
                        displayName = email.split('@')[0];
                        avatarLetter = displayName.charAt(0).toUpperCase();
                    }

                    userNameElement.textContent = displayName;
                    userAvatarElement.textContent = avatarLetter;
                } else {
                    userNameElement.textContent = 'Administrador';
                    userAvatarElement.textContent = 'A';
                }
            } catch (error) {
                console.error('‚ùå Error in forceUpdateUserInfo:', error);
            }
        }

        // DATA LOADING FUNCTIONS
        async function loadData() {
            console.log('üìä === LOADING DATA ===');
            try {
                if (!window.api) {
                    console.warn('‚ö†Ô∏è API not ready, skipping data load');
                    return;
                }

                customers = await api.getCustomers();
                console.log(`‚úÖ Customers loaded: ${customers.length}`);

                displayCustomers();

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                const tbody = document.getElementById('customers-table');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Erro ao carregar dados</td></tr>';
                }
            }
        }

        function displayCustomers() {
            const tbody = document.getElementById('customers-table');
            if (!tbody) {
                console.error('‚ùå Customers table not found');
                return;
            }

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum cliente encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = customers.map(customer => `
                <tr>
                    <td><strong>${customer.name}</strong></td>
                    <td>${customer.cpf || '-'}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.city || '-'}</td>
                    <td>
                        <div class="flex gap-2">
                            <button class="btn btn-outline" onclick="editCustomer(${customer.id})" style="padding: 0.375rem 0.75rem;">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})" style="padding: 0.375rem 0.75rem;">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            console.log(`‚úÖ Displayed ${customers.length} customers`);
        }

        // FORM SUBMISSION HANDLER
        function setupFormHandler() {
            const form = document.getElementById('customer-form');
            if (!form) {
                console.warn('‚ö†Ô∏è Form not found yet');
                return;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('üíæ FORM SUBMITTED');

                const saveBtn = document.getElementById('save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvando...';

                try {
                    const birthDate = document.getElementById('birth-date').value;
                    const formData = {
                        name: document.getElementById('name').value,
                        cpf: document.getElementById('cpf').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value,
                        address: document.getElementById('address').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        postalCode: document.getElementById('postal-code').value,
                        birthDate: birthDate ? new Date(birthDate).toISOString() : null,
                        notes: document.getElementById('notes').value || null
                    };

                    let savedCustomer;
                    if (editingCustomerId) {
                        savedCustomer = await api.updateCustomer(editingCustomerId, formData);
                        const index = customers.findIndex(c => c.id === editingCustomerId);
                        if (index !== -1) {
                            customers[index] = savedCustomer;
                        }
                        alert('Cliente atualizado com sucesso!');
                    } else {
                        savedCustomer = await api.createCustomer(formData);
                        customers.push(savedCustomer);
                        alert('Cliente criado com sucesso!');
                    }

                    displayCustomers();
                    window.closeCustomerModal();

                } catch (error) {
                    console.error('‚ùå Error saving customer:', error);
                    alert('Erro ao salvar cliente: ' + error.message);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                }
            });

            // CPF formatting
            const cpfInput = document.getElementById('cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    e.target.value = value;
                });
            }

            // Phone formatting
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                    value = value.replace(/(\d{4})-(\d)(\d{4})/, '$1$2-$3');
                    e.target.value = value;
                });
            }

            // CEP formatting
            const postalCodeInput = document.getElementById('postal-code');
            if (postalCodeInput) {
                postalCodeInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                    e.target.value = value;
                });
            }

            console.log('‚úÖ Form handler setup complete');
        }

        // INITIALIZATION FUNCTION
        function initializePage() {
            if (pageInitialized) {
                console.log('‚ö†Ô∏è Page already initialized');
                return;
            }

            console.log('üöÄ === INITIALIZING PAGE ===');

            // Force user info update immediately
            forceUpdateUserInfo();

            // Set up repeated updates for user info
            setInterval(forceUpdateUserInfo, 3000);

            // Set up form handler
            setupFormHandler();

            // Try to load data
            loadData();

            pageInitialized = true;
            console.log('‚úÖ Page initialization complete');
        }

        // START EXECUTION
        if (checkAuth()) {
            console.log('üìã Authentication passed, starting initialization...');

            // MULTIPLE DOM READY LISTENERS FOR MAXIMUM COMPATIBILITY
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePage);
                console.log('üìù Added DOMContentLoaded listener');
            } else {
                console.log('üìÑ DOM already ready, initializing immediately');
                initializePage();
            }

            // Backup initialization attempts
            setTimeout(() => {
                console.log('‚è∞ Backup initialization (1s)');
                initializePage();
            }, 1000);

            setTimeout(() => {
                console.log('‚è∞ Final backup initialization (3s)');
                initializePage();
            }, 3000);

            console.log('üéØ === CUSTOMERS PAGE SETUP COMPLETE ===');
        }
    </script>
</body>
</html>